<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Sender - Evolution API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .contacts-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .contact-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .contact-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .contact-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            color: #495057;
        }

        .contact-number {
            font-size: 0.9em;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .selected-file {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 8px;
            color: #004085;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            display: none;
        }

        .log-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #dc3545;
            color: #721c24;
        }

        .log-entry.success {
            border-left-color: #28a745;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± WhatsApp Sender</h1>
            <p>Envio em massa via Evolution API</p>
        </div>

        <div class="content">
            <!-- Configura√ß√£o da API -->
            <div class="section">
                <h2>üîß Configura√ß√£o da API</h2>
                <div class="form-group">
                    <label>URL da API Evolution:</label>
                    <input type="text" id="apiUrl" placeholder="https://sua-api.com" value="https://evo.kdsolucoes.com.br">
                </div>
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="text" id="apiKey" placeholder="Sua API Key">
                </div>
                <div class="form-group">
                    <label>Nome da Inst√¢ncia:</label>
                    <input type="text" id="instanceName" placeholder="nome-da-instancia">
                </div>
                <button class="btn btn-primary" onclick="testConnection()">
                    <span>üîå Testar Conex√£o</span>
                </button>
                <button class="btn btn-secondary" onclick="fetchContacts()">
                    <span>üìã Buscar Contatos</span>
                </button>
                <div id="connectionStatus" class="status"></div>
            </div>

            <!-- Lista de Contatos -->
            <div class="section">
                <h2>üë• Contatos e Conversas</h2>
                <div class="form-group">
                    <label>Filtrar por:</label>
                    <select id="filterType">
                        <option value="all">Todos (Contatos + Conversas)</option>
                        <option value="contacts">Apenas Contatos</option>
                        <option value="chats">Apenas Conversas</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="searchContact" placeholder="üîç Buscar contato..." onkeyup="filterContacts()">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        Selecionar Todos
                    </label>
                </div>
                <div id="contactsList" class="contacts-list">
                    <p style="text-align: center; color: #6c757d;">Clique em "Buscar Contatos" para carregar</p>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalContacts">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="selectedContacts">0</div>
                        <div class="stat-label">Selecionados</div>
                    </div>
                </div>
            </div>

            <!-- Upload de Planilha -->
            <div class="section">
                <h2>üìä Upload de Planilha</h2>
                <div class="file-input-wrapper">
                    <input type="file" id="spreadsheetFile" accept=".csv,.xlsx,.xls" onchange="handleSpreadsheet()">
                    <label class="file-input-label">
                        üìÅ Clique para selecionar arquivo CSV ou Excel
                    </label>
                </div>
                <div id="spreadsheetInfo" class="selected-file"></div>
            </div>

            <!-- Mensagem -->
            <div class="section">
                <h2>üí¨ Mensagem</h2>
                <div class="form-group">
                    <label>Texto da Mensagem:</label>
                    <textarea id="messageText" placeholder="Digite sua mensagem aqui..."></textarea>
                </div>
                <div class="form-group">
                    <label>Imagem:</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="mediaFile" accept="image/*" onchange="handleMedia()">
                        <label class="file-input-label">
                            üñºÔ∏è Clique para selecionar imagem (opcional)
                        </label>
                    </div>
                    <div id="mediaInfo" class="selected-file"></div>
                </div>
                <div class="form-group">
                    <label>V√≠deo (URL):</label>
                    <input type="text" id="videoUrl" placeholder="https://exemplo.com/video.mp4 (opcional)">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">üí° Cole o link direto do v√≠deo hospedado online</small>
                </div>
                <div class="form-group">
                    <label>√Åudio (URL):</label>
                    <input type="text" id="audioUrl" placeholder="https://exemplo.com/audio.mp3 (opcional)">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">üé§ Ser√° enviado como √°udio de voz (gravado)</small>
                </div>
                <div class="form-group">
                    <label>Delay entre mensagens (segundos):</label>
                    <input type="number" id="delay" value="3" min="1" max="60">
                </div>
            </div>

            <!-- Envio -->
            <div class="section">
                <h2>üöÄ Enviar Mensagens</h2>
                <button class="btn btn-primary" onclick="sendMessages()" style="width: 100%; font-size: 1.2em; padding: 15px;">
                    <span>üì§ Enviar para Selecionados</span>
                </button>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div id="sendStatus" class="status"></div>
                <div id="logContainer" class="log-container"></div>
            </div>

            <!-- Relat√≥rios e Hist√≥rico -->
            <div class="section">
                <h2>üìä Relat√≥rios e Hist√≥rico</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSent">0</div>
                        <div class="stat-label">Total Enviados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="successRate">0%</div>
                        <div class="stat-label">Taxa de Sucesso</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalFailed">0</div>
                        <div class="stat-label">Falhas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastSendTime">-</div>
                        <div class="stat-label">√öltimo Envio</div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="loadHistory()">
                        <span>üîÑ Atualizar Estat√≠sticas</span>
                    </button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">
                        <span>üì• Exportar Excel</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearHistory()">
                        <span>üóëÔ∏è Limpar Hist√≥rico</span>
                    </button>
                </div>
                <div id="historyTable" style="margin-top: 20px; overflow-x: auto;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let allContacts = [];
        let selectedMedia = null;
        let sendHistory = JSON.parse(localStorage.getItem('whatsappSendHistory')) || [];

        // Testar conex√£o com a API
        async function testConnection() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const instanceName = document.getElementById('instanceName').value;
            const status = document.getElementById('connectionStatus');

            if (!apiUrl || !apiKey || !instanceName) {
                showStatus(status, 'error', '‚ùå Preencha todos os campos de configura√ß√£o');
                return;
            }

            showStatus(status, 'info', 'üîÑ Testando conex√£o...');

            try {
                const response = await fetch(`${apiUrl}/instance/connectionState/${encodeURIComponent(instanceName)}`, {
                    method: 'GET',
                    headers: {
                        'apikey': apiKey
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showStatus(status, 'success', `‚úÖ Conectado! Status: ${data.state || 'Conectado'}`);
                } else {
                    showStatus(status, 'error', `‚ùå Erro: ${data.message || 'Falha na conex√£o'}`);
                }
            } catch (error) {
                showStatus(status, 'error', `‚ùå Erro de conex√£o: ${error.message}`);
            }
        }

        // Buscar contatos e conversas
        async function fetchContacts() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const instanceName = document.getElementById('instanceName').value;
            const filterType = document.getElementById('filterType').value;
            const status = document.getElementById('connectionStatus');

            if (!apiUrl || !apiKey || !instanceName) {
                showStatus(status, 'error', '‚ùå Configure a API primeiro');
                return;
            }

            showStatus(status, 'info', 'üîÑ Buscando contatos...');
            allContacts = [];

            try {
                // Buscar conversas
                if (filterType === 'all' || filterType === 'chats') {
                    const chatsResponse = await fetch(`${apiUrl}/chat/findChats/${encodeURIComponent(instanceName)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({})
                    });

                    if (chatsResponse.ok) {
                        const chatsData = await chatsResponse.json();
                        console.log('Conversas recebidas:', chatsData);
                        
                        if (Array.isArray(chatsData)) {
                            chatsData.forEach(chat => {
                                // Verificar se √© grupo
                                if (chat.id && !chat.id.includes('@g.us')) {
                                    // Pegar o n√∫mero real do remoteJid ou id
                                    const phoneNumber = chat.remoteJid || chat.id;
                                    const displayName = chat.pushName || chat.name || phoneNumber.split('@')[0];
                                    
                                    allContacts.push({
                                        name: displayName,
                                        number: phoneNumber,
                                        type: 'chat'
                                    });
                                }
                            });
                        }
                    }
                }

                // Buscar contatos
                if (filterType === 'all' || filterType === 'contacts') {
                    const contactsResponse = await fetch(`${apiUrl}/chat/findContacts/${encodeURIComponent(instanceName)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({})
                    });

                    if (contactsResponse.ok) {
                        const contactsData = await contactsResponse.json();
                        console.log('Contatos recebidos:', contactsData);
                        
                        if (Array.isArray(contactsData)) {
                            contactsData.forEach(contact => {
                                if (contact.id && !contact.id.includes('@g.us')) {
                                    // Pegar o n√∫mero real do remoteJid ou id
                                    const phoneNumber = contact.remoteJid || contact.id;
                                    const displayName = contact.pushName || contact.name || phoneNumber.split('@')[0];
                                    
                                    // Evitar duplicatas
                                    if (!allContacts.find(c => c.number === phoneNumber)) {
                                        allContacts.push({
                                            name: displayName,
                                            number: phoneNumber,
                                            type: 'contact'
                                        });
                                    }
                                }
                            });
                        }
                    }
                }

                if (allContacts.length > 0) {
                    displayContacts();
                    showStatus(status, 'success', `‚úÖ ${allContacts.length} contatos carregados`);
                } else {
                    showStatus(status, 'error', '‚ùå Nenhum contato encontrado');
                }
            } catch (error) {
                showStatus(status, 'error', `‚ùå Erro: ${error.message}`);
                console.error('Erro completo:', error);
            }
        }

        // Exibir contatos na lista
        function displayContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';

            allContacts.forEach((contact, index) => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.innerHTML = `
                    <input type="checkbox" id="contact_${index}" value="${contact.number}">
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-number">${contact.number}</div>
                    </div>
                `;
                contactsList.appendChild(div);
            });

            updateStats();
        }

        // Filtrar contatos
        function filterContacts() {
            const search = document.getElementById('searchContact').value.toLowerCase();
            const items = document.querySelectorAll('.contact-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }

        // Selecionar todos
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.contact-item input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                if (cb.closest('.contact-item').style.display !== 'none') {
                    cb.checked = selectAll;
                }
            });

            updateStats();
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            document.getElementById('totalContacts').textContent = allContacts.length;
            
            const selected = document.querySelectorAll('.contact-item input[type="checkbox"]:checked').length;
            document.getElementById('selectedContacts').textContent = selected;
        }

        // Adicionar listener para atualizar stats quando checkbox mudar
        document.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox' && e.target.id.startsWith('contact_')) {
                updateStats();
            }
        });

        // Processar planilha
        function handleSpreadsheet() {
            const file = document.getElementById('spreadsheetFile').files[0];
            const info = document.getElementById('spreadsheetInfo');

            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    let count = 0;
                    jsonData.forEach((row, index) => {
                        if (index === 0) return; // Pular cabe√ßalho
                        
                        const name = row[0] || `Contato ${index}`;
                        let number = String(row[1] || '').replace(/\D/g, '');
                        
                        if (number && number.length >= 10) {
                            if (!number.includes('@')) {
                                number = number + '@s.whatsapp.net';
                            }
                            
                            if (!allContacts.find(c => c.number === number)) {
                                allContacts.push({ name, number, type: 'spreadsheet' });
                                count++;
                            }
                        }
                    });

                    displayContacts();
                    info.style.display = 'block';
                    info.textContent = `‚úÖ ${count} contatos importados da planilha`;
                } catch (error) {
                    info.style.display = 'block';
                    info.style.background = '#f8d7da';
                    info.style.color = '#721c24';
                    info.textContent = `‚ùå Erro ao processar planilha: ${error.message}`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Processar m√≠dia (apenas imagens)
        function handleMedia() {
            const file = document.getElementById('mediaFile').files[0];
            const info = document.getElementById('mediaInfo');

            if (!file) {
                selectedMedia = null;
                info.style.display = 'none';
                return;
            }

            // Limitar tamanho: 5MB para imagens
            const maxSize = 5 * 1024 * 1024;
            
            if (file.size > maxSize) {
                info.style.display = 'block';
                info.style.background = '#f8d7da';
                info.style.color = '#721c24';
                info.textContent = `‚ùå Imagem muito grande! M√°ximo: 5MB. Tamanho atual: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
                selectedMedia = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                selectedMedia = {
                    base64: e.target.result,
                    filename: file.name,
                    mimetype: file.type
                };

                info.style.display = 'block';
                info.style.background = '#e7f3ff';
                info.style.color = '#004085';
                info.textContent = `‚úÖ Imagem selecionada: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            };
            reader.readAsDataURL(file);
        }

        // Enviar mensagens
        async function sendMessages() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const instanceName = document.getElementById('instanceName').value;
            const messageText = document.getElementById('messageText').value;
            const delay = parseInt(document.getElementById('delay').value) * 1000;
            const status = document.getElementById('sendStatus');
            const logContainer = document.getElementById('logContainer');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            // Valida√ß√µes
            if (!apiUrl || !apiKey || !instanceName) {
                showStatus(status, 'error', '‚ùå Configure a API primeiro');
                return;
            }

            const videoUrl = document.getElementById('videoUrl').value.trim();
            const audioUrl = document.getElementById('audioUrl').value.trim();

            if (!messageText && !selectedMedia && !videoUrl && !audioUrl) {
                showStatus(status, 'error', '‚ùå Digite uma mensagem ou selecione uma m√≠dia');
                return;
            }

            // Obter contatos selecionados
            const selectedCheckboxes = document.querySelectorAll('.contact-item input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                showStatus(status, 'error', '‚ùå Selecione pelo menos um contato');
                return;
            }

            const recipients = Array.from(selectedCheckboxes).map(cb => {
                const contactItem = cb.closest('.contact-item');
                return {
                    number: cb.value,
                    name: contactItem.querySelector('.contact-name').textContent
                };
            });

            // Preparar interface
            logContainer.innerHTML = '';
            logContainer.style.display = 'block';
            progressBar.style.display = 'block';
            showStatus(status, 'info', `üîÑ Enviando para ${recipients.length} contatos...`);

            let success = 0;
            let failed = 0;

            // Enviar para cada contato
            for (let i = 0; i < recipients.length; i++) {
                const recipient = recipients[i];
                const progress = Math.round(((i + 1) / recipients.length) * 100);
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';

                try {
                    let endpoint, payload;

                    if (videoUrl) {
                        // Enviar v√≠deo por URL
                        endpoint = `${apiUrl}/message/sendMedia/${encodeURIComponent(instanceName)}`;
                        payload = {
                            number: recipient.number.replace('@s.whatsapp.net', ''),
                            mediatype: 'video',
                            media: videoUrl,
                            caption: messageText || ''
                        };
                    } else if (selectedMedia) {
                        // Enviar imagem em base64 - remover o prefixo data:image/...;base64,
                        const base64Data = selectedMedia.base64.split(',')[1] || selectedMedia.base64;
                        
                        endpoint = `${apiUrl}/message/sendMedia/${encodeURIComponent(instanceName)}`;
                        payload = {
                            number: recipient.number.replace('@s.whatsapp.net', ''),
                            mediatype: selectedMedia.mimetype.split('/')[0],
                            mimetype: selectedMedia.mimetype,
                            caption: messageText || '',
                            media: base64Data
                        };
                    } else {
                        // Enviar apenas texto
                        endpoint = `${apiUrl}/message/sendText/${encodeURIComponent(instanceName)}`;
                        payload = {
                            number: recipient.number.replace('@s.whatsapp.net', ''),
                            text: messageText
                        };
                    }

                    console.log('üì§ Enviando:', { endpoint, payload });

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify(payload)
                    });

                    const responseData = await response.json();
                    console.log('üì• Resposta:', responseData);

                    if (response.ok) {
                        success++;
                        addLog(`‚úÖ Enviado para ${recipient.name}`, 'success');
                        saveToHistory(recipient, 'success', messageText);
                    } else {
                        failed++;
                        const errorMsg = responseData.message || JSON.stringify(responseData);
                        addLog(`‚ùå Erro ao enviar para ${recipient.name}: ${errorMsg}`, 'error');
                        saveToHistory(recipient, 'failed', messageText, errorMsg);
                    }
                } catch (error) {
                    failed++;
                    addLog(`‚ùå Erro ao enviar para ${recipient.name}: ${error.message}`, 'error');
                    saveToHistory(recipient, 'failed', messageText, error.message);
                    console.error('Erro completo:', error);
                }

                // Delay entre mensagens (exceto na √∫ltima)
                if (i < recipients.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // Resultado final
            showStatus(status, success > 0 ? 'success' : 'error', 
                `‚úÖ ${success} enviadas | ‚ùå ${failed} falharam`);
            
            // Atualizar estat√≠sticas
            loadHistory();
        }

        // Adicionar log
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Mostrar status
        function showStatus(element, type, message) {
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        // Salvar no hist√≥rico
        function saveToHistory(recipient, status, message, error = '') {
            const record = {
                id: Date.now(),
                name: recipient.name,
                number: recipient.number,
                message: message,
                status: status,
                error: error,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('pt-BR'),
                time: new Date().toLocaleTimeString('pt-BR')
            };
            
            sendHistory.unshift(record);
            
            // Limitar a 1000 registros
            if (sendHistory.length > 1000) {
                sendHistory = sendHistory.slice(0, 1000);
            }
            
            localStorage.setItem('whatsappSendHistory', JSON.stringify(sendHistory));
        }

        // Carregar hist√≥rico e estat√≠sticas
        function loadHistory() {
            sendHistory = JSON.parse(localStorage.getItem('whatsappSendHistory')) || [];
            
            // Calcular estat√≠sticas
            const totalSent = sendHistory.length;
            const successCount = sendHistory.filter(r => r.status === 'success').length;
            const failedCount = sendHistory.filter(r => r.status === 'failed').length;
            const successRate = totalSent > 0 ? Math.round((successCount / totalSent) * 100) : 0;
            
            // Atualizar dashboard
            document.getElementById('totalSent').textContent = totalSent;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('totalFailed').textContent = failedCount;
            
            if (sendHistory.length > 0) {
                const lastSend = new Date(sendHistory[0].timestamp);
                document.getElementById('lastSendTime').textContent = lastSend.toLocaleTimeString('pt-BR');
            }
            
            // Criar tabela de hist√≥rico
            displayHistoryTable();
        }

        // Exibir tabela de hist√≥rico
        function displayHistoryTable() {
            const container = document.getElementById('historyTable');
            
            if (sendHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">Nenhum envio registrado ainda</p>';
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left;">Data/Hora</th>
                            <th style="padding: 12px; text-align: left;">Nome</th>
                            <th style="padding: 12px; text-align: left;">N√∫mero</th>
                            <th style="padding: 12px; text-align: left;">Mensagem</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Mostrar apenas os √∫ltimos 50 registros
            const recentHistory = sendHistory.slice(0, 50);
            
            recentHistory.forEach(record => {
                const statusIcon = record.status === 'success' ? '‚úÖ' : '‚ùå';
                const statusColor = record.status === 'success' ? '#28a745' : '#dc3545';
                const messagePreview = record.message.length > 50 ? record.message.substring(0, 50) + '...' : record.message;
                
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px;">${record.date} ${record.time}</td>
                        <td style="padding: 10px;">${record.name}</td>
                        <td style="padding: 10px; font-family: monospace;">${record.number.split('@')[0]}</td>
                        <td style="padding: 10px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${messagePreview}</td>
                        <td style="padding: 10px; text-align: center; color: ${statusColor}; font-weight: bold;">${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.9em;">
                    Mostrando ${recentHistory.length} de ${sendHistory.length} registros
                </p>
            `;
            
            container.innerHTML = html;
        }

        // Exportar para Excel
        function exportToExcel() {
            if (sendHistory.length === 0) {
                alert('Nenhum dado para exportar!');
                return;
            }
            
            // Preparar dados para exporta√ß√£o
            const exportData = sendHistory.map(record => ({
                'Data': record.date,
                'Hora': record.time,
                'Nome': record.name,
                'N√∫mero': record.number.split('@')[0],
                'Mensagem': record.message,
                'Status': record.status === 'success' ? 'Sucesso' : 'Falha',
                'Erro': record.error || '-'
            }));
            
            // Criar workbook
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Hist√≥rico de Envios');
            
            // Baixar arquivo
            const fileName = `whatsapp_historico_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ Relat√≥rio exportado: ${fileName}`);
        }

        // Limpar hist√≥rico
        function clearHistory() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar todo o hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.')) {
                sendHistory = [];
                localStorage.removeItem('whatsappSendHistory');
                loadHistory();
                alert('‚úÖ Hist√≥rico limpo com sucesso!');
            }
        }

        // Carregar estat√≠sticas ao iniciar
        window.addEventListener('load', function() {
            loadHistory();
        });
    </script>
</body>
</html>
