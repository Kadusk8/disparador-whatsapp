<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparador WhatsApp - Evolution API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.9em;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .contacts-header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .contacts-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .contact-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .contact-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            color: #212529;
        }

        .contact-number {
            font-size: 0.9em;
            color: #6c757d;
        }

        .contact-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-contact {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-group {
            background: #fff3cd;
            color: #856404;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .message-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .message-config h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .media-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .media-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .media-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .media-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .media-upload {
            margin-top: 15px;
            padding: 20px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            text-align: center;
            background: white;
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .upload-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .file-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .file-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .progress-info {
            margin-top: 10px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
        }

        .log-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #495057;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #6c757d;
            margin-right: 10px;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #17a2b8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .manual-input {
            margin-top: 15px;
        }

        .manual-input textarea {
            min-height: 200px;
        }

        .help-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .delay-config {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .delay-config label {
            font-weight: 600;
            color: #495057;
        }

        .delay-config input {
            width: 100px;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .contacts-header {
                flex-direction: column;
            }

            .media-options {
                flex-direction: column;
            }

            .media-btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Disparador WhatsApp</h1>
            <p>Evolution API - Envio em Massa Profissional</p>
        </div>

        <div class="config-section">
            <div class="config-grid">
                <div class="form-group">
                    <label>üîó URL da Evolution API</label>
                    <input type="text" id="apiUrl" placeholder="https://sua-api.com" value="https://evoapi.automacaocomia.pro">
                </div>
                <div class="form-group">
                    <label>üîë API Key</label>
                    <input type="password" id="apiKey" placeholder="Sua API Key">
                </div>
                <div class="form-group">
                    <label>üì± Nome da Inst√¢ncia</label>
                    <input type="text" id="instanceName" placeholder="atendimento" value="atendimento">
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="connectAPI()">üîå Conectar</button>
                <span class="status disconnected" id="connectionStatus">
                    ‚ö´ Desconectado
                </span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('api')">üåê Todos da API</button>
            <button class="tab" onclick="switchTab('contacts')">üë• Apenas Contatos</button>
            <button class="tab" onclick="switchTab('conversations')">üí¨ Apenas Conversas</button>
            <button class="tab" onclick="switchTab('groups')">üë• Apenas Grupos</button>
            <button class="tab" onclick="switchTab('spreadsheet')">üìä Planilha</button>
            <button class="tab" onclick="switchTab('manual')">‚úçÔ∏è Manual</button>
        </div>

        <!-- ABA: TODOS DA API -->
        <div id="tab-api" class="tab-content active">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo: Todos da API</strong><br>
                Busca automaticamente todos os contatos, conversas e grupos da sua inst√¢ncia WhatsApp.
            </div>

            <div class="contacts-header">
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Buscar contato..." onkeyup="filterContacts()">
                <button class="btn btn-success" onclick="fetchContacts()">üîÑ Buscar Contatos</button>
                <button class="btn btn-primary" onclick="selectAll()">‚úÖ Selecionar Todos</button>
                <button class="btn btn-danger" onclick="clearSelection()">‚ùå Limpar Sele√ß√£o</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalContacts">0</div>
                    <div class="stat-label">Total de Contatos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedContacts">0</div>
                    <div class="stat-label">Selecionados</div>
                </div>
            </div>

            <div class="contacts-list" id="contactsList">
                <p style="text-align: center; color: #6c757d;">Clique em "Buscar Contatos" para carregar</p>
            </div>

            <div class="message-config">
                <h3>üí¨ Configurar Mensagem</h3>
                <textarea id="messageText" placeholder="Digite sua mensagem aqui..."></textarea>

                <div class="delay-config">
                    <label>‚è±Ô∏è Delay entre mensagens (segundos):</label>
                    <input type="number" id="messageDelay" value="3" min="1" max="60">
                    <span class="help-text">Recomendado: 3-5 segundos</span>
                </div>

                <h4 style="margin-top: 20px; margin-bottom: 10px;">üìé Tipo de M√≠dia</h4>
                <div class="media-options">
                    <button class="media-btn active" onclick="selectMediaType('text')">üìù Apenas Texto</button>
                    <button class="media-btn" onclick="selectMediaType('image')">üñºÔ∏è Imagem</button>
                    <button class="media-btn" onclick="selectMediaType('video')">üé• V√≠deo</button>
                </div>

                <div class="media-upload" id="mediaUpload" style="display: none;">
                    <input type="file" id="mediaFile" class="file-input" accept="image/*,video/*" onchange="previewMedia()">
                    <label for="mediaFile" class="upload-label">üìÅ Escolher Arquivo</label>
                    <p class="help-text">Ou cole a URL da m√≠dia abaixo:</p>
                    <input type="text" id="mediaUrl" placeholder="https://exemplo.com/imagem.jpg" style="width: 100%; margin-top: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <div class="file-preview" id="filePreview"></div>
                </div>

                <button class="btn btn-success" onclick="sendMessages()" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1em;">
                    üöÄ Enviar Mensagens
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-info" id="progressInfo">Aguardando...</div>
            </div>

            <div class="log-container" id="logContainer"></div>
        </div>

        <!-- ABA: APENAS CONTATOS -->
        <div id="tab-contacts" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo: Apenas Contatos</strong><br>
                Busca apenas contatos individuais (sem grupos).
            </div>
            <p style="text-align: center; padding: 40px; color: #6c757d;">
                Esta aba filtra apenas contatos individuais da API.<br>
                Use a aba "Todos da API" e os contatos ser√£o filtrados automaticamente.
            </p>
        </div>

        <!-- ABA: APENAS CONVERSAS -->
        <div id="tab-conversations" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo: Apenas Conversas</strong><br>
                Busca apenas conversas ativas (sem grupos).
            </div>
            <p style="text-align: center; padding: 40px; color: #6c757d;">
                Esta aba filtra apenas conversas ativas da API.<br>
                Use a aba "Todos da API" e as conversas ser√£o filtradas automaticamente.
            </p>
        </div>

        <!-- ABA: APENAS GRUPOS -->
        <div id="tab-groups" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo: Apenas Grupos</strong><br>
                Busca apenas grupos do WhatsApp.
            </div>
            <p style="text-align: center; padding: 40px; color: #6c757d;">
                Esta aba filtra apenas grupos da API.<br>
                Use a aba "Todos da API" e os grupos ser√£o filtrados automaticamente.
            </p>
        </div>

        <!-- ABA: PLANILHA -->
        <div id="tab-spreadsheet" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo: Upload de Planilha</strong><br>
                Fa√ßa upload de um arquivo CSV ou TXT com n√∫meros de telefone (um por linha).
            </div>

            <div class="media-upload">
                <input type="file" id="spreadsheetFile" class="file-input" accept=".csv,.txt" onchange="loadSpreadsheet()">
                <label for="spreadsheetFile" class="upload-label">üìä Escolher Planilha</label>
                <p class="help-text">Formato: Um n√∫mero por linha (ex: 5511999999999)</p>
            </div>

            <div class="contacts-list" id="spreadsheetList" style="margin-top: 20px;">
                <p style="text-align: center; color: #6c757d;">Nenhuma planilha carregada</p>
            </div>

            <div class="message-config" style="margin-top: 20px;">
                <h3>üí¨ Configurar Mensagem</h3>
                <textarea id="messageTextSpreadsheet" placeholder="Digite sua mensagem aqui..."></textarea>

                <div class="delay-config">
                    <label>‚è±Ô∏è Delay entre mensagens (segundos):</label>
                    <input type="number" id="messageDelaySpreadsheet" value="3" min="1" max="60">
                </div>

                <h4 style="margin-top: 20px; margin-bottom: 10px;">üìé Tipo de M√≠dia</h4>
                <div class="media-options">
                    <button class="media-btn active" onclick="selectMediaType('text', 'spreadsheet')">üìù Apenas Texto</button>
                    <button class="media-btn" onclick="selectMediaType('image', 'spreadsheet')">üñºÔ∏è Imagem</button>
                    <button class="media-btn" onclick="selectMediaType('video', 'spreadsheet')">üé• V√≠deo</button>
                </div>

                <div class="media-upload" id="mediaUploadSpreadsheet" style="display: none;">
                    <input type="file" id="mediaFileSpreadsheet" class="file-input" accept="image/*,video/*" onchange="previewMedia('spreadsheet')">
                    <label for="mediaFileSpreadsheet" class="upload-label">üìÅ Escolher Arquivo</label>
                    <p class="help-text">Ou cole a URL da m√≠dia abaixo:</p>
                    <input type="text" id="mediaUrlSpreadsheet" placeholder="https://exemplo.com/imagem.jpg" style="width: 100%; margin-top: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <div class="file-preview" id="filePreviewSpreadsheet"></div>
                </div>

                <button class="btn btn-success" onclick="sendMessagesSpreadsheet()" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1em;">
                    üöÄ Enviar Mensagens
                </button>
            </div>

            <div class="progress-container" id="progressContainerSpreadsheet">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFillSpreadsheet">0%</div>
                </div>
                <div class="progress-info" id="progressInfoSpreadsheet">Aguardando...</div>
            </div>

            <div class="log-container" id="logContainerSpreadsheet"></div>
        </div>

        <!-- ABA: MANUAL -->
        <div id="tab-manual" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo: Entrada Manual</strong><br>
                Digite os n√∫meros manualmente, um por linha.
            </div>

            <div class="manual-input">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;">üìù Digite os n√∫meros (um por linha):</label>
                <textarea id="manualNumbers" placeholder="5511999999999&#10;5511888888888&#10;5511777777777"></textarea>
                <p class="help-text">Formato: C√≥digo do pa√≠s + DDD + n√∫mero (ex: 5511999999999)</p>
            </div>

            <div class="message-config" style="margin-top: 20px;">
                <h3>üí¨ Configurar Mensagem</h3>
                <textarea id="messageTextManual" placeholder="Digite sua mensagem aqui..."></textarea>

                <div class="delay-config">
                    <label>‚è±Ô∏è Delay entre mensagens (segundos):</label>
                    <input type="number" id="messageDelayManual" value="3" min="1" max="60">
                </div>

                <h4 style="margin-top: 20px; margin-bottom: 10px;">üìé Tipo de M√≠dia</h4>
                <div class="media-options">
                    <button class="media-btn active" onclick="selectMediaType('text', 'manual')">üìù Apenas Texto</button>
                    <button class="media-btn" onclick="selectMediaType('image', 'manual')">üñºÔ∏è Imagem</button>
                    <button class="media-btn" onclick="selectMediaType('video', 'manual')">üé• V√≠deo</button>
                </div>

                <div class="media-upload" id="mediaUploadManual" style="display: none;">
                    <input type="file" id="mediaFileManual" class="file-input" accept="image/*,video/*" onchange="previewMedia('manual')">
                    <label for="mediaFileManual" class="upload-label">üìÅ Escolher Arquivo</label>
                    <p class="help-text">Ou cole a URL da m√≠dia abaixo:</p>
                    <input type="text" id="mediaUrlManual" placeholder="https://exemplo.com/imagem.jpg" style="width: 100%; margin-top: 10px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px;">
                    <div class="file-preview" id="filePreviewManual"></div>
                </div>

                <button class="btn btn-success" onclick="sendMessagesManual()" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1em;">
                    üöÄ Enviar Mensagens
                </button>
            </div>

            <div class="progress-container" id="progressContainerManual">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFillManual">0%</div>
                </div>
                <div class="progress-info" id="progressInfoManual">Aguardando...</div>
            </div>

            <div class="log-container" id="logContainerManual"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o da API
        let apiConfig = {
            url: '',
            key: '',
            instance: '',
            connected: false
        };

        // Dados
        let allContacts = [];
        let selectedMediaType = 'text';
        let currentMode = 'api';

        // Conectar √† API
        function connectAPI() {
            const url = document.getElementById('apiUrl').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            const instance = document.getElementById('instanceName').value.trim();

            if (!url || !key || !instance) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }

            apiConfig.url = url.replace(/\/$/, ''); // Remove barra final
            apiConfig.key = key;
            apiConfig.instance = instance;
            apiConfig.connected = true;

            document.getElementById('connectionStatus').className = 'status connected';
            document.getElementById('connectionStatus').innerHTML = 'üü¢ Conectado';

            addLog('‚úÖ Conectado √† Evolution API!', 'success');
            alert('‚úÖ Conectado com sucesso!');
        }

        // Buscar contatos da API - VERS√ÉO COMPLETA PARA EVOLUTION API 2.3.5
        async function fetchContacts() {
            if (!apiConfig.connected) {
                alert('‚ùå Conecte-se √† API primeiro!');
                return;
            }

            addLog('Buscando contatos e conversas da Evolution API 2.3.5...', 'info');
            document.getElementById('contactsList').innerHTML = '<p style="text-align: center;"><span class="loading"></span> Carregando...</p>';

            try {
                allContacts = [];
                const uniqueNumbers = new Set();
                const encodedInstance = encodeURIComponent(apiConfig.instance);

                // LISTA DE ENDPOINTS PARA TESTAR (Evolution API 2.3.5)
                const endpoints = [
                    `/chat/findChats/${encodedInstance}`,
                    `/chat/fetchAllContacts/${encodedInstance}`,
                    `/contact/fetchProfile/${encodedInstance}`,
                    `/instance/fetchContacts/${encodedInstance}`,
                ];

                let successCount = 0;

                // TENTAR CADA ENDPOINT
                for (const endpoint of endpoints) {
                    try {
                        const url = `${apiConfig.url}${endpoint}`;
                        console.log('üîç Tentando:', url);
                        addLog(`Testando: ${endpoint}`, 'info');

                        const response = await fetch(url, {
                            method: 'GET',
                            headers: { 
                                'apikey': apiConfig.key,
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log(`Status ${endpoint}:`, response.status);

                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Dados de ${endpoint}:`, data);

                            // Processar resposta (diferentes formatos)
                            let items = [];
                            
                            if (Array.isArray(data)) {
                                items = data;
                            } else if (data.data && Array.isArray(data.data)) {
                                items = data.data;
                            } else if (data.chats && Array.isArray(data.chats)) {
                                items = data.chats;
                            } else if (data.contacts && Array.isArray(data.contacts)) {
                                items = data.contacts;
                            } else if (data.response && Array.isArray(data.response)) {
                                items = data.response;
                            }

                            console.log(`${items.length} itens encontrados em ${endpoint}`);

                            // Processar cada item
                            items.forEach(item => {
                                let number = '';
                                let name = '';
                                let type = 'contact';

                                // Extrair ID/n√∫mero (m√∫ltiplos formatos)
                                if (item.id) {
                                    if (item.id.includes('@g.us')) {
                                        number = item.id;
                                        type = 'group';
                                    } else if (item.id.includes('@s.whatsapp.net')) {
                                        number = item.id.replace('@s.whatsapp.net', '');
                                    } else if (item.id.includes('@c.us')) {
                                        number = item.id.replace('@c.us', '');
                                    } else {
                                        number = item.id;
                                    }
                                } else if (item.jid) {
                                    if (item.jid.includes('@g.us')) {
                                        number = item.jid;
                                        type = 'group';
                                    } else {
                                        number = item.jid.replace('@s.whatsapp.net', '').replace('@c.us', '');
                                    }
                                } else if (item.number) {
                                    number = item.number;
                                } else if (item.remoteJid) {
                                    number = item.remoteJid.replace('@s.whatsapp.net', '').replace('@c.us', '');
                                }

                                // Extrair nome
                                name = item.pushName || item.name || item.notify || item.verifiedName || number;

                                // Adicionar se v√°lido e √∫nico
                                if (number && !uniqueNumbers.has(number)) {
                                    uniqueNumbers.add(number);
                                    allContacts.push({
                                        number: number,
                                        name: name,
                                        type: type,
                                        id: item.id || item.jid || number
                                    });
                                }
                            });

                            if (items.length > 0) {
                                successCount++;
                                addLog(`‚úÖ ${items.length} itens de ${endpoint}`, 'success');
                            }
                        } else {
                            const errorData = await response.json();
                            console.error(`Erro em ${endpoint}:`, errorData);
                        }

                    } catch (error) {
                        console.error(`Erro em ${endpoint}:`, error);
                    }
                }

                // VERIFICAR SE ENCONTROU ALGO
                if (allContacts.length === 0) {
                    // Tentar buscar mensagens recentes como √∫ltimo recurso
                    try {
                        addLog('Tentando buscar mensagens recentes...', 'info');
                        const messagesUrl = `${apiConfig.url}/chat/findMessages/${encodedInstance}`;
                        console.log('üîç Tentando mensagens:', messagesUrl);

                        const messagesResponse = await fetch(messagesUrl, {
                            method: 'POST',
                            headers: { 
                                'apikey': apiConfig.key,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                limit: 100
                            })
                        });

                        if (messagesResponse.ok) {
                            const messagesData = await messagesResponse.json();
                            console.log('Mensagens:', messagesData);

                            let messages = [];
                            if (Array.isArray(messagesData)) {
                                messages = messagesData;
                            } else if (messagesData.data && Array.isArray(messagesData.data)) {
                                messages = messagesData.data;
                            } else if (messagesData.messages && Array.isArray(messagesData.messages)) {
                                messages = messagesData.messages;
                            }

                            messages.forEach(msg => {
                                if (msg.key && msg.key.remoteJid) {
                                    const jid = msg.key.remoteJid;
                                    let number = '';
                                    let type = 'chat';

                                    if (jid.includes('@g.us')) {
                                        number = jid;
                                        type = 'group';
                                    } else {
                                        number = jid.replace('@s.whatsapp.net', '').replace('@c.us', '');
                                    }

                                    if (number && !uniqueNumbers.has(number)) {
                                        uniqueNumbers.add(number);
                                        allContacts.push({
                                            number: number,
                                            name: msg.pushName || number,
                                            type: type,
                                            id: jid
                                        });
                                    }
                                }
                            });

                            if (messages.length > 0) {
                                addLog(`‚úÖ ${messages.length} conversas de mensagens`, 'success');
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao buscar mensagens:', error);
                    }
                }

                // RESULTADO FINAL
                if (allContacts.length === 0) {
                    throw new Error('Nenhum contato/conversa encontrado. Verifique se:\n1. A inst√¢ncia est√° conectada ao WhatsApp\n2. H√° conversas/contatos no WhatsApp\n3. A API Key tem permiss√µes corretas');
                }

                console.log('‚úÖ Total de contatos √∫nicos:', allContacts.length);
                addLog(`üéâ ${allContacts.length} contatos/conversas carregados!`, 'success');
                updateStats();
                renderContacts();

            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                addLog('‚ùå Erro: ' + error.message, 'error');
                
                document.getElementById('contactsList').innerHTML = `
                    <div style="padding: 20px; text-align: left;">
                        <h4 style="color: #ff4444; margin-bottom: 15px;">‚ùå N√£o foi poss√≠vel buscar contatos</h4>
                        <p style="margin-bottom: 10px;"><strong>Erro:</strong> ${error.message}</p>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin-bottom: 10px;"><strong>üîç Verifique:</strong></p>
                            <ol style="margin-left: 20px; line-height: 1.8;">
                                <li><strong>Inst√¢ncia conectada?</strong> Acesse o painel da Evolution API e veja se a inst√¢ncia "atendimento" est√° com status "open"</li>
                                <li><strong>WhatsApp tem conversas?</strong> Abra o WhatsApp Web e veja se h√° conversas/contatos</li>
                                <li><strong>API Key correta?</strong> Verifique se a API Key tem permiss√µes de leitura</li>
                                <li><strong>Nome da inst√¢ncia:</strong> Confirme que √© exatamente "atendimento" (min√∫sculo, sem espa√ßos)</li>
                            </ol>
                        </div>

                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin-bottom: 10px;"><strong>üß™ Teste manual:</strong></p>
                            <p style="font-size: 12px; margin-bottom: 5px;">Abra uma nova aba e teste esta URL:</p>
                            <code style="background: #fff; padding: 8px; border-radius: 4px; display: block; font-size: 11px; word-break: break-all; margin-top: 5px;">
                                ${apiConfig.url}/chat/findChats/${encodeURIComponent(apiConfig.instance)}
                            </code>
                            <p style="font-size: 12px; margin-top: 10px; color: #666;">
                                Adicione o header: <code style="background: #fff; padding: 2px 6px;">apikey: SUA_API_KEY</code>
                            </p>
                        </div>

                        <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin-bottom: 10px;"><strong>üí° Alternativa:</strong></p>
                            <p>Se a inst√¢ncia n√£o tem conversas ainda, use a aba <strong>"üìä Planilha"</strong> ou <strong>"‚úçÔ∏è Manual"</strong> para adicionar n√∫meros manualmente.</p>
                        </div>

                        <button class="btn" onclick="fetchContacts()" style="margin-top: 15px;">üîÑ Tentar Novamente</button>
                    </div>
                `;
            }
        }

        // Renderizar lista de contatos
        function renderContacts() {
            const container = document.getElementById('contactsList');
            
            if (allContacts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">Nenhum contato encontrado</p>';
                return;
            }

            let html = '';
            allContacts.forEach((contact, index) => {
                const badgeClass = contact.type === 'group' ? 'badge-group' : 'badge-contact';
                const badgeText = contact.type === 'group' ? 'üë• Grupo' : 'üë§ Contato';
                
                html += `
                    <div class="contact-item">
                        <input type="checkbox" id="contact-${index}" onchange="updateStats()">
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="contact-number">${contact.number}</div>
                        </div>
                        <span class="contact-badge ${badgeClass}">${badgeText}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const total = allContacts.length;
            const selected = document.querySelectorAll('#contactsList input[type="checkbox"]:checked').length;
            
            document.getElementById('totalContacts').textContent = total;
            document.getElementById('selectedContacts').textContent = selected;
        }

        // Selecionar todos
        function selectAll() {
            document.querySelectorAll('#contactsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateStats();
        }

        // Limpar sele√ß√£o
        function clearSelection() {
            document.querySelectorAll('#contactsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateStats();
        }

        // Filtrar contatos
        function filterContacts() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.contact-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }

        // Trocar aba
        function switchTab(tab) {
            // Remover active de todas as abas
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Ativar aba selecionada
            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            currentMode = tab;
        }

        // Selecionar tipo de m√≠dia
        function selectMediaType(type, mode = 'api') {
            selectedMediaType = type;
            
            const suffix = mode === 'api' ? '' : mode.charAt(0).toUpperCase() + mode.slice(1);
            const buttons = document.querySelectorAll(`#tab-${mode} .media-btn`);
            const mediaUpload = document.getElementById(`mediaUpload${suffix}`);
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'text') {
                mediaUpload.style.display = 'none';
            } else {
                mediaUpload.style.display = 'block';
            }
        }

        // Preview de m√≠dia
        function previewMedia(mode = 'api') {
            const suffix = mode === 'api' ? '' : mode.charAt(0).toUpperCase() + mode.slice(1);
            const fileInput = document.getElementById(`mediaFile${suffix}`);
            const preview = document.getElementById(`filePreview${suffix}`);
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    if (file.type.startsWith('image/')) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    } else if (file.type.startsWith('video/')) {
                        preview.innerHTML = `<video src="${e.target.result}" controls style="max-width: 300px;"></video>`;
                    }
                    preview.classList.add('show');
                };
                
                reader.readAsDataURL(file);
            }
        }

        // Enviar mensagens (API)
        async function sendMessages() {
            if (!apiConfig.connected) {
                alert('‚ùå Conecte-se √† API primeiro!');
                return;
            }

            const selectedContacts = [];
            document.querySelectorAll('#contactsList input[type="checkbox"]:checked').forEach((cb, index) => {
                const contactIndex = parseInt(cb.id.replace('contact-', ''));
                selectedContacts.push(allContacts[contactIndex]);
            });

            if (selectedContacts.length === 0) {
                alert('‚ùå Selecione pelo menos um contato!');
                return;
            }

            const message = document.getElementById('messageText').value.trim();
            if (!message) {
                alert('‚ùå Digite uma mensagem!');
                return;
            }

            const delay = parseInt(document.getElementById('messageDelay').value) * 1000;
            
            // Preparar m√≠dia
            let mediaUrl = '';
            if (selectedMediaType !== 'text') {
                const urlInput = document.getElementById('mediaUrl').value.trim();
                const fileInput = document.getElementById('mediaFile');
                
                if (urlInput) {
                    mediaUrl = urlInput;
                } else if (fileInput.files && fileInput.files[0]) {
                    // Converter para base64
                    const file = fileInput.files[0];
                    mediaUrl = await fileToBase64(file);
                } else {
                    alert('‚ùå Adicione uma m√≠dia ou escolha "Apenas Texto"!');
                    return;
                }
            }

            // Iniciar envio
            await sendBatch(selectedContacts, message, mediaUrl, delay, 'api');
        }

        // Enviar mensagens (Planilha)
        async function sendMessagesSpreadsheet() {
            if (!apiConfig.connected) {
                alert('‚ùå Conecte-se √† API primeiro!');
                return;
            }

            if (allContacts.length === 0) {
                alert('‚ùå Carregue uma planilha primeiro!');
                return;
            }

            const message = document.getElementById('messageTextSpreadsheet').value.trim();
            if (!message) {
                alert('‚ùå Digite uma mensagem!');
                return;
            }

            const delay = parseInt(document.getElementById('messageDelaySpreadsheet').value) * 1000;
            
            let mediaUrl = '';
            if (selectedMediaType !== 'text') {
                const urlInput = document.getElementById('mediaUrlSpreadsheet').value.trim();
                const fileInput = document.getElementById('mediaFileSpreadsheet');
                
                if (urlInput) {
                    mediaUrl = urlInput;
                } else if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    mediaUrl = await fileToBase64(file);
                } else {
                    alert('‚ùå Adicione uma m√≠dia ou escolha "Apenas Texto"!');
                    return;
                }
            }

            await sendBatch(allContacts, message, mediaUrl, delay, 'spreadsheet');
        }

        // Enviar mensagens (Manual)
        async function sendMessagesManual() {
            if (!apiConfig.connected) {
                alert('‚ùå Conecte-se √† API primeiro!');
                return;
            }

            const numbersText = document.getElementById('manualNumbers').value.trim();
            if (!numbersText) {
                alert('‚ùå Digite pelo menos um n√∫mero!');
                return;
            }

            const numbers = numbersText.split('\n').map(n => n.trim()).filter(n => n);
            if (numbers.length === 0) {
                alert('‚ùå Nenhum n√∫mero v√°lido encontrado!');
                return;
            }

            const contacts = numbers.map(num => ({
                number: num,
                name: num,
                type: 'contact',
                id: num
            }));

            const message = document.getElementById('messageTextManual').value.trim();
            if (!message) {
                alert('‚ùå Digite uma mensagem!');
                return;
            }

            const delay = parseInt(document.getElementById('messageDelayManual').value) * 1000;
            
            let mediaUrl = '';
            if (selectedMediaType !== 'text') {
                const urlInput = document.getElementById('mediaUrlManual').value.trim();
                const fileInput = document.getElementById('mediaFileManual');
                
                if (urlInput) {
                    mediaUrl = urlInput;
                } else if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    mediaUrl = await fileToBase64(file);
                } else {
                    alert('‚ùå Adicione uma m√≠dia ou escolha "Apenas Texto"!');
                    return;
                }
            }

            await sendBatch(contacts, message, mediaUrl, delay, 'manual');
        }

        // Enviar lote de mensagens
        async function sendBatch(contacts, message, mediaUrl, delay, mode) {
            const suffix = mode === 'api' ? '' : mode.charAt(0).toUpperCase() + mode.slice(1);
            const progressContainer = document.getElementById(`progressContainer${suffix}`);
            const progressFill = document.getElementById(`progressFill${suffix}`);
            const progressInfo = document.getElementById(`progressInfo${suffix}`);
            
            progressContainer.classList.add('show');
            
            let success = 0;
            let failed = 0;

            for (let i = 0; i < contacts.length; i++) {
                const contact = contacts[i];
                const progress = Math.round(((i + 1) / contacts.length) * 100);
                
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
                progressInfo.textContent = `Enviando ${i + 1} de ${contacts.length}...`;

                try {
                    // Formatar n√∫mero
                    let number = contact.number;
                    if (contact.type === 'group') {
                        // Grupo j√° vem com @g.us
                        number = contact.id;
                    } else {
                        // Remover caracteres especiais
                        number = number.replace(/\D/g, '');
                        // Adicionar @s.whatsapp.net se n√£o tiver
                        if (!number.includes('@')) {
                            number = number + '@s.whatsapp.net';
                        }
                    }

                    // Preparar payload
                    let endpoint = '';
                    let payload = {};

                    if (selectedMediaType === 'text') {
                        endpoint = '/message/sendText/' + encodeURIComponent(apiConfig.instance);
                        payload = {
                            number: number,
                            text: message
                        };
                    } else if (selectedMediaType === 'image') {
                        endpoint = '/message/sendMedia/' + encodeURIComponent(apiConfig.instance);
                        payload = {
                            number: number,
                            mediatype: 'image',
                            media: mediaUrl,
                            caption: message
                        };
                    } else if (selectedMediaType === 'video') {
                        endpoint = '/message/sendMedia/' + encodeURIComponent(apiConfig.instance);
                        payload = {
                            number: number,
                            mediatype: 'video',
                            media: mediaUrl,
                            caption: message
                        };
                    }

                    console.log('Enviando para:', number);
                    console.log('Payload:', payload);

                    const response = await fetch(apiConfig.url + endpoint, {
                        method: 'POST',
                        headers: {
                            'apikey': apiConfig.key,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        success++;
                        addLog(`‚úÖ Enviado para ${contact.name} (${contact.number})`, 'success', mode);
                    } else {
                        const errorData = await response.json();
                        failed++;
                        addLog(`‚ùå Erro ao enviar para ${contact.name}: ${errorData.message || 'Erro desconhecido'}`, 'error', mode);
                    }

                } catch (error) {
                    failed++;
                    addLog(`‚ùå Erro ao enviar para ${contact.name}: ${error.message}`, 'error', mode);
                }

                // Delay entre mensagens
                if (i < contacts.length - 1) {
                    await sleep(delay);
                }
            }

            progressInfo.textContent = `‚úÖ Conclu√≠do! ${success} enviadas, ${failed} falharam`;
            addLog(`üéâ Envio conclu√≠do! ${success} sucesso, ${failed} falhas`, 'info', mode);
        }

        // Carregar planilha
        function loadSpreadsheet() {
            const fileInput = document.getElementById('spreadsheetFile');
            const file = fileInput.files[0];
            
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                
                allContacts = lines.map(num => ({
                    number: num,
                    name: num,
                    type: 'contact',
                    id: num
                }));

                document.getElementById('spreadsheetList').innerHTML = `
                    <p style="text-align: center; color: #28a745; font-weight: 600;">
                        ‚úÖ ${allContacts.length} n√∫meros carregados!
                    </p>
                    <div style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                        ${allContacts.map(c => `<div style="padding: 8px; background: white; margin: 5px 0; border-radius: 4px;">${c.number}</div>`).join('')}
                    </div>
                `;
            };
            reader.readAsText(file);
        }

        // Converter arquivo para base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Adicionar log
        function addLog(message, type = 'info', mode = 'api') {
            const suffix = mode === 'api' ? '' : mode.charAt(0).toUpperCase() + mode.slice(1);
            const container = document.getElementById(`logContainer${suffix}`);
            
            const time = new Date().toLocaleTimeString();
            const logClass = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : 'log-info';
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="${logClass}">${message}</span>`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
